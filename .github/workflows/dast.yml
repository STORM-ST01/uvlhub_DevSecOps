name: Pruebas Dinámicas de Seguridad (DAST)

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  issues: write

jobs:
  dast:
    runs-on: ubuntu-latest
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Instalar dependencias
        run: |
          pip install -r requirements.txt
          pip list
          pip check

      - name: Iniciar aplicación Flask
        run: |
          export FLASK_APP_NAME=app
          export FLASK_ENV=development
          export SQLALCHEMY_DATABASE_URI=sqlite:///:memory:
          export DOMAIN=localhost
          flask run --host=0.0.0.0 --port=5000 > flask.log 2>&1 &
          for i in {1..60}; do
            curl -s http://localhost:5000 && break
            echo "Esperando a que Flask inicie ($i/60)..."
            sleep 1
          done
          curl http://localhost:5000 || (echo "Error: No se pudo conectar a Flask"; cat flask.log; exit 1)

      - name: Mostrar logs de Flask si falla
        if: failure()
        run: |
          cat flask.log

      - name: Escaneo OWASP ZAP
        run: |
          docker run -v $(pwd):/zap/wrk/:rw -t zaproxy/zap-stable zap-baseline.py \
            -t http://localhost:5000 \
            -J report_json.json \
            -r report_html.html \
            -m 10 \
            -d

      - name: Verificar directorio de trabajo
        run: |
          pwd
          ls -la

      - name: Verificar archivo generado
        run: |
          ls -l report_json.json || echo "report_json.json no encontrado"
          cat report_json.json || echo "No se pudo leer report_json.json"
          if [ ! -s report_json.json ]; then
            echo "Error: report_json.json está vacío"
            exit 1
          fi

      - name: Instalar jq
        run: |
          sudo apt-get update && sudo apt-get install -y jq

      - name: Crear engagement en DefectDojo
        env:
          DEFECTDOJO_TOKEN: ${{ secrets.DEFECTDOJO_TOKEN }}
          DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
        run: |
          TODAY=$(date +%Y-%m-%d)
          NEXT_WEEK=$(date -d "7 days" +%Y-%m-%d)
          RESPONSE=$(curl --fail --location --request POST "$DEFECTDOJO_URL/api/v2/engagements/" \
            -H "Authorization: Token $DEFECTDOJO_TOKEN" \
            -H "Content-Type: application/json" \
            --data-raw '{
              "name": "DAST-Pipeline-${{ github.run_id }}",
              "description": "Escaneo DAST para commit ${{ github.sha }}",
              "product": "${{ secrets.DEFECTDOJO_PRODUCT_ID }}",
              "target_start": "'"$TODAY"'",
              "target_end": "'"$NEXT_WEEK"'",
              "engagement_type": "CI/CD",
              "status": "In Progress",
              "build_id": "${{ github.run_id }}",
              "commit_hash": "${{ github.sha }}",
              "branch_tag": "${{ github.ref_name }}",
              "version": "${{ github.sha }}",
              "deduplication_on_engagement": false
            }')
          echo "Respuesta de DefectDojo: $RESPONSE"
          ENGAGEMENT_ID=$(echo "$RESPONSE" | jq -r '.id')
          if [ -z "$ENGAGEMENT_ID" ] || [ "$ENGAGEMENT_ID" = "null" ]; then
            echo "Error: No se pudo crear el engagement. Respuesta: $RESPONSE"
            exit 1
          fi
          echo "DEFECTDOJO_ENGAGEMENT_ID=$ENGAGEMENT_ID" >> $GITHUB_ENV

      - name: Subir informe a DefectDojo
        env:
          DEFECTDOJO_TOKEN: ${{ secrets.DEFECTDOJO_TOKEN }}
          DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
          ENGAGEMENT_ID: ${{ env.DEFECTDOJO_ENGAGEMENT_ID }}
        run: |
          TODAY=$(date +%Y-%m-%d)
          RESPONSE=$(curl --fail --location --request POST "$DEFECTDOJO_URL/api/v2/import-scan/" \
            -H "Authorization: Token $DEFECTDOJO_TOKEN" \
            -H "Content-Type: multipart/form-data" \
            -F "file=@report_json.json" \
            -F "scan_type=ZAP Scan" \
            -F "engagement=$ENGAGEMENT_ID" \
            -F "scan_date=$TODAY" \
            -F "verified=true" \
            -F "active=true" \
            -F "minimum_severity=Informational" \
            -F "skip_duplicates=true" \
            -F "close_old_findings=false" \
            --write-out "%{http_code}" 2> response_body)
          HTTP_CODE=$RESPONSE
          RESPONSE_BODY=$(cat response_body)
          echo "Código HTTP: $HTTP_CODE"
          echo "Respuesta de import-scan: $RESPONSE_BODY"
          if [ "$HTTP_CODE" -ne 201 ]; then
            echo "Error: No se pudo importar el escaneo. Código HTTP: $HTTP_CODE, Respuesta: $RESPONSE_BODY"
            exit 1
          fi
          TEST_ID=$(echo "$RESPONSE_BODY" | jq -r '.test')
          if [ -z "$TEST_ID" ] || [ "$TEST_ID" = "null" ]; then
            echo "Error: No se generó un Test ID. Respuesta: $RESPONSE_BODY"
            exit 1
          fi
          echo "Escaneo importado correctamente con Test ID: $TEST_ID"

      - name: Crear issue con resultados de ZAP
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('report_json.json', 'utf8'));
            const alerts = report.site[0].alerts || [];
            const alertSummary = alerts.map(alert => `- ${alert.name}: ${alert.riskdesc} (${alert.count} instancias)`).join('\n');
            
            const issueTitle = 'ZAP Scan Baseline Report';
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['ZAP']
            });
            
            const issueExists = existingIssues.data.some(issue => issue.title === issueTitle);
            if (!issueExists) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: `## ZAP Scan Baseline Report\n\nResultados del escaneo de seguridad:\n${alertSummary}\n\nDetalles completos en el reporte adjunto.`,
                labels: ['ZAP', 'security']
              });
            } else {
              console.log('Issue ya existe, omitiendo creación.');
            }

      - name: Subir informe DAST
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: |
            report_json.json
            report_html.html